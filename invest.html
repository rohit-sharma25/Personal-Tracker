<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GROWW - Wealth Intelligence</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="css/animations.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root {
            --groww-green: #00D09C;
            --groww-dark: #121212;
            --groww-bg: #F9FAFB;
        }

        body {
            background: var(--groww-bg);
            color: var(--text);
        }

        .invest-header {
            background: #fff;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .invest-nav {
            display: flex;
            gap: 32px;
            margin-top: 12px;
        }

        .invest-nav-link {
            text-decoration: none;
            color: var(--muted);
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .invest-nav-link.active {
            color: var(--groww-green);
            border-bottom-color: var(--groww-green);
        }

        .portfolio-summary-card {
            background: #fff;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-left h1 {
            font-size: 2.5rem;
            margin: 4px 0;
        }

        .summary-right {
            text-align: right;
        }

        .return-badge {
            background: rgba(0, 208, 156, 0.1);
            color: var(--groww-green);
            padding: 6px 12px;
            border-radius: 99px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .return-badge.negative {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .instrument-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .instrument-card {
            background: #fff;
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .instrument-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .price-ticker-container {
            background: var(--primary);
            color: #fff;
            padding: 12px 0;
            border-radius: var(--radius-md);
            margin: 20px 0;
        }

        .savings-bar-container {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 99px;
            overflow: hidden;
            margin: 8px 0;
        }

        .savings-bar {
            height: 100%;
            background: var(--groww-green);
            border-radius: 99px;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="header-content animate-fade-in-down">
                <div class="brand">
                    <div class="brand-logo">
                        <img src="img/logo.jpg" alt="E"
                            onerror="if(this.parentElement){this.parentElement.innerText='E'}">
                    </div>
                    <div class="brand-text">
                        <h1>EXPENSIFY</h1>
                        <p>Manage your expenses</p>
                    </div>
                </div>

                <nav class="header-nav" style="display: flex; gap: 24px; margin-left: 40px;">
                    <a href="index.html" class="nav-link"
                        style="text-decoration: none; color: var(--muted); font-weight: 600; transition: color 0.2s;">Dashboard</a>
                    <a href="invest.html" class="nav-link active"
                        style="text-decoration: none; color: var(--primary); font-weight: 700; border-bottom: 2px solid var(--primary); padding-bottom: 4px;">Investments</a>
                    <a href="expense.html" class="nav-link"
                        style="text-decoration: none; color: var(--muted); font-weight: 600; transition: color 0.2s;">Expenses</a>
                </nav>

                <div class="user-section" id="auth-section">

                    <div id="logged-out-view" class="row">
                        <button id="login-btn" class="btn btn-primary">Sign in with Google</button>
                    </div>

                    <div id="user-info" class="user-section hidden">
                        <div class="user-info">
                            <span id="user-name" class="user-name"></span>
                            <span id="user-email" class="user-email"></span>
                        </div>
                        <img id="user-photo" class="user-photo" src="" alt="Profile" />
                        <button id="logout-btn" class="btn btn-ghost">Logout</button>
                    </div>
                </div>
            </div>

            <!-- Sub Navigation -->
            <nav class="invest-nav"
                style="margin-top: 10px; border-top: 1px solid var(--border-light); padding-top: 10px;">
                <a href="#" class="invest-nav-link active" data-tab="dashboard">Dashboard</a>
                <a href="#" class="invest-nav-link" data-tab="stocks">Holdings</a>
                <a href="#" class="invest-nav-link" data-tab="discover">Market</a>
                <a href="#" class="invest-nav-link" data-tab="savings">Savings</a>
                <button class="btn btn-primary" style="margin-left:auto;"
                    onclick="document.getElementById('add-holding-modal').style.display='flex'">
                    + Add Investments
                </button>

        </div>
    </header>

    <!-- Add Investment Modal -->
    <div id="add-holding-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:#fff; padding:0; border-radius:16px; width:450px; box-shadow:var(--shadow-lg); overflow:hidden;">
            <div style="padding: 20px; background: var(--groww-bg); border-bottom: 1px solid var(--border-light);">
                <h3 style="margin:0;">âž• Add Investment</h3>
            </div>

            <!-- Modal Tabs -->
            <div style="display:flex; border-bottom: 1px solid var(--border-light);">
                <button type="button" class="modal-tab active" data-target="tab-stock"
                    style="flex:1; padding:12px; border:none; background:none; cursor:pointer; font-weight:600; border-bottom: 2px solid var(--groww-green);">Stocks</button>
                <button type="button" class="modal-tab" data-target="tab-gold"
                    style="flex:1; padding:12px; border:none; background:none; cursor:pointer; font-weight:600; color:var(--muted);">Gold/Silver</button>
                <button type="button" class="modal-tab" data-target="tab-fixed"
                    style="flex:1; padding:12px; border:none; background:none; cursor:pointer; font-weight:600; color:var(--muted);">FD/RD</button>
                <button type="button" class="modal-tab" data-target="tab-sip"
                    style="flex:1; padding:12px; border:none; background:none; cursor:pointer; font-weight:600; color:var(--muted);">SIP</button>
            </div>

            <form id="add-investment-form" style="padding: 24px;">
                <!-- Stock Tab -->
                <div id="tab-stock" class="modal-section">
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Symbol
                            (e.g. RELIANCE.BSE, IBM)</label>
                        <input type="text" name="stock_symbol" placeholder="RELIANCE.BSE"
                            style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                    </div>
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Company
                            Name</label>
                        <input type="text" name="stock_name" placeholder="Reliance Industries"
                            style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <label
                                style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Quantity</label>
                            <input type="number" name="stock_qty" step="0.01"
                                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Avg Buy
                                Price</label>
                            <input type="number" name="stock_price" step="0.01"
                                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                    </div>
                </div>

                <!-- Gold/Silver Tab -->
                <div id="tab-gold" class="modal-section" style="display:none;">
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Asset
                            Type</label>
                        <select name="gold_type"
                            style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                            <option value="GOLD">Gold (24K)</option>
                            <option value="SILVER">Silver</option>
                        </select>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Weight
                                (grams)</label>
                            <input type="number" name="gold_qty" step="0.001"
                                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Buy
                                Price (Total)</label>
                            <input type="number" name="gold_price" step="0.01"
                                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                    </div>
                </div>

                <!-- Fixed Income Tab -->
                <div id="tab-fixed" class="modal-section" style="display:none;">
                    <div style="margin-bottom:16px;">
                        <label
                            style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Type</label>
                        <select name="fixed_type"
                            style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                            <option value="FD">Fixed Deposit (FD)</option>
                            <option value="RD">Recurring Deposit (RD)</option>
                        </select>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Bank /
                            Institution Name</label>
                        <input type="text" name="fixed_name" placeholder="SBI Bank"
                            style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <div>
                            <label
                                style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Principal
                                / Monthly</label>
                            <input type="number" name="fixed_amount" step="1"
                                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                        <div>
                            <label
                                style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Interest
                                Rate (%)</label>
                            <input type="number" name="fixed_roi" step="0.01"
                                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Maturity
                            Amount (Target)</label>
                        <input type="number" name="fixed_maturity" step="1"
                            style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                    </div>
                </div>

                <!-- SIP Tab -->
                <div id="tab-sip" class="modal-section" style="display:none;">
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">SIP
                            Name</label>
                        <input type="text" name="sip_name" placeholder="Nifty 50 Index Fund"
                            style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <div>
                            <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Monthly
                                Amount</label>
                            <input type="number" name="sip_amount" step="1"
                                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Total
                                Invested So Far</label>
                            <input type="number" name="sip_invested" step="1"
                                style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:0.8rem; font-weight:700; color:var(--muted);">Target Goal
                            Amount</label>
                        <input type="number" name="sip_target" step="1"
                            style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                    </div>
                </div>

                <div style="display:flex; gap:12px; margin-top:24px;">
                    <button type="submit" class="btn btn-primary"
                        style="flex:1; background:var(--groww-green); border:none;">Save Investment</button>
                    <button type="button" class="btn btn-ghost"
                        onclick="document.getElementById('add-holding-modal').style.display='none'"
                        style="flex:1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <main class="container" style="margin-top: 32px;">

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active animate-fade-in-up">
            <div class="portfolio-summary-card">
                <div class="summary-left">
                    <span class="p-label" style="font-size: 0.9rem;">Current Value</span>
                    <h1 id="total-wealth">â‚¹0</h1>
                    <div style="display: flex; gap: 16px; align-items: center; margin-top: 8px;">
                        <span class="return-badge" id="total-returns">+â‚¹0 (0%)</span>
                        <span style="color: var(--muted); font-size: 0.85rem;">Total Returns</span>
                    </div>
                </div>
                <div class="summary-right">
                    <div class="p-stat">
                        <span class="p-label">1D Returns</span>
                        <span class="p-value up" id="daily-gain" style="font-size: 1.2rem;">+â‚¹0 (0%)</span>
                    </div>
                </div>
            </div>

            <div class="price-ticker-container">
                <div class="price-ticker" id="price-ticker">
                    <!-- Live Prices Injected Here -->
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Performance Chart -->
                <div class="chart-card" style="grid-column: span 2;">
                    <div class="chart-header">
                        <h3 class="chart-title">ðŸ“ˆ Portfolio Performance</h3>
                    </div>
                    <div class="chart-container" style="height: 350px;">
                        <div id="portfolio-performance-chart"></div>
                    </div>
                </div>

                <!-- AI Wealth Insight -->
                <div class="stat-card"
                    style="background: linear-gradient(135deg, #1A1A1A 0%, #404040 100%); color: #fff;">
                    <div class="stat-card-header">
                        <div class="stat-card-icon">ðŸ¤–</div>
                        <span class="stat-card-badge" style="background: var(--groww-green); color: #000;">AI
                            ADVISOR</span>
                    </div>
                    <div class="stat-card-body">
                        <h3>Wealth Insight</h3>
                        <p id="ai-wealth-insight"
                            style="font-size: 0.95rem; line-height: 1.6; margin-top: 12px; opacity: 0.9;">
                            Analyzing metrics to provide guidance...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Holdings Tab -->
        <div id="stocks" class="tab-content animate-fade-in-up">
            <div class="section-header">
                <h3 class="section-title">Your Investment Holdings</h3>
            </div>
            <div class="instrument-grid" id="stocks-list">
                <!-- Holdings Injected Here -->
            </div>
        </div>

        <!-- Market Tab -->
        <div id="discover" class="tab-content animate-fade-in-up">
            <div class="section-header">
                <h3 class="section-title">Market Discovery</h3>
            </div>
            <div class="instrument-grid" id="gold-list">
                <!-- Market Highlights Injected Here -->
            </div>
        </div>

        <!-- Savings Tab -->
        <div id="savings" class="tab-content animate-fade-in-up">
            <div class="section-header">
                <h3 class="section-title">SIP & Savings Goals</h3>
            </div>
            <div class="instrument-grid" id="savings-list">
                <!-- Savings Items Injected Here -->
            </div>
        </div>

    </main>

    <script type="module">
        import { AuthService } from './js/auth-service.js';
        import { DBService } from './js/db-service.js';
        import { AIService } from './js/ai-service.js';
        import { PriceService } from './js/price-service.js';
        import { InvestmentEngine } from './js/investment-engine.js';

        let contextData = {
            investments: { holdings: [], sipPlans: [], fdAccounts: [], rdAccounts: [], prices: {} }
        };
        let portfolioChart = null;
        let portfolioHistory = [];
        let currentUser = null;
        let activeModalTab = 'tab-stock';

        // Tab Logic
        document.querySelectorAll('.invest-nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.invest-nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                link.classList.add('active');
                document.getElementById(link.dataset.tab).classList.add('active');
            });
        });

        // Modal Tab Logic
        document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelectorAll('.modal-tab').forEach(t => {
                    t.classList.remove('active');
                    t.style.color = 'var(--muted)';
                    t.style.borderBottom = 'none';
                });
                document.querySelectorAll('.modal-section').forEach(s => s.style.display = 'none');

                tab.classList.add('active');
                tab.style.color = 'var(--text)';
                tab.style.borderBottom = '2px solid var(--groww-green)';
                document.getElementById(tab.dataset.target).style.display = 'block';
                activeModalTab = tab.dataset.target;
            });
        });

        // DOM Elements for Auth
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loggedOutView = document.getElementById('logged-out-view');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const userPhoto = document.getElementById('user-photo');

        if (loginBtn) {
            loginBtn.addEventListener('click', async () => {
                try { await AuthService.login(); } catch (e) { alert(e.message); }
            });
        }
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try { await AuthService.logout(); window.location.reload(); } catch (e) { alert(e.message); }
            });
        }

        AuthService.onUserChange(async (user) => {
            currentUser = user;
            if (user) {
                if (userInfo) userInfo.classList.remove('hidden');
                if (loggedOutView) loggedOutView.classList.add('hidden');
                if (userName) userName.textContent = user.displayName;
                if (userEmail) userEmail.textContent = user.email;
                if (userPhoto) userPhoto.src = user.photoURL;
                loadData(user.uid);
            } else {
                if (userInfo) userInfo.classList.add('hidden');
                if (loggedOutView) loggedOutView.classList.remove('hidden');
                // Optional: handle local mode or guest
                const isLocal = AuthService.isLocalOnly(); // Assuming this method exists or similar logic
                // For now, if logged out, we might want to show empty state or guest
                if (AuthService.isLocalOnly && AuthService.isLocalOnly()) {
                    // Local mode handling if needed
                }
                loadData(null);
            }
        });

        async function loadData(uid) {
            // Subscriptions
            DBService.subscribe(uid, 'holdings', (data) => {
                contextData.investments.holdings = data;
                updateUI();
                renderStocksList();
            });

            DBService.subscribe(uid, 'sipPlans', (data) => {
                contextData.investments.sipPlans = data;
                updateUI();
                renderSavingsList();
            });

            DBService.subscribe(uid, 'fdAccounts', (data) => {
                contextData.investments.fdAccounts = data;
                updateUI();
                renderSavingsList();
            });

            DBService.subscribe(uid, 'rdAccounts', (data) => {
                contextData.investments.rdAccounts = data;
                updateUI();
                renderSavingsList();
            });

            DBService.subscribe(uid, 'cachedMarketData', (data) => {
                const prices = {};
                if (data) data.forEach(p => prices[p.id] = p);
                contextData.investments.prices = prices;
                updateUI();
                updateTickerUI(prices);
            });

            // Form Handling
            const form = document.getElementById('add-investment-form');
            form.onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(form);

                try {
                    let collection = '';
                    let id = '';
                    let data = {};

                    if (activeModalTab === 'tab-stock') {
                        collection = 'holdings';
                        id = formData.get('stock_symbol').toUpperCase();
                        data = {
                            symbol: id,
                            name: formData.get('stock_name'),
                            quantity: parseFloat(formData.get('stock_qty')),
                            avgPrice: parseFloat(formData.get('stock_price')),
                            type: 'STOCK',
                            timestamp: new Date().toISOString()
                        };
                    }
                    else if (activeModalTab === 'tab-gold') {
                        collection = 'holdings';
                        id = formData.get('gold_type'); // GOLD or SILVER
                        data = {
                            symbol: id,
                            name: id === 'GOLD' ? '24K Digital Gold' : 'Silver Petal',
                            quantity: parseFloat(formData.get('gold_qty')),
                            avgPrice: parseFloat(formData.get('gold_price')) / parseFloat(formData.get('gold_qty')), // Calc avg per gram
                            type: 'COMMODITY',
                            timestamp: new Date().toISOString()
                        };
                    }
                    else if (activeModalTab === 'tab-fixed') {
                        const type = formData.get('fixed_type');
                        collection = type === 'FD' ? 'fdAccounts' : 'rdAccounts';
                        id = crypto.randomUUID();
                        data = {
                            id,
                            name: formData.get('fixed_name'),
                            principal: parseFloat(formData.get('fixed_amount')), // For RD this acts as monthly
                            interestRate: parseFloat(formData.get('fixed_roi')),
                            maturityValue: parseFloat(formData.get('fixed_maturity')),
                            startDate: new Date().toISOString(),
                            // RD specific
                            currentBalance: type === 'RD' ? parseFloat(formData.get('fixed_amount')) : parseFloat(formData.get('fixed_amount')),
                            targetAmount: parseFloat(formData.get('fixed_maturity'))
                        };
                    }
                    else if (activeModalTab === 'tab-sip') {
                        collection = 'sipPlans';
                        id = crypto.randomUUID();
                        data = {
                            id,
                            name: formData.get('sip_name'),
                            monthlyAmount: parseFloat(formData.get('sip_amount')),
                            currentInvested: parseFloat(formData.get('sip_invested')),
                            targetAmount: parseFloat(formData.get('sip_target')),
                            startDate: new Date().toISOString()
                        };
                    }

                    if (!id) throw new Error("Invalid ID generated");

                    await DBService.saveData(uid, collection, id, data);
                    document.getElementById('add-holding-modal').style.display = 'none';
                    form.reset();
                    alert('Investment added successfully!');

                    if (collection === 'holdings') {
                        syncPrices(uid);
                    }
                } catch (err) { alert('Error: ' + err.message); }
            };

            // Backend Simulation Trigger (Simulating Cloud Function)
            // In a real app, this would be a scheduled job on the server.
            // Here, the client triggers the sync to update Firestore 'cachedMarketData'.
            const triggerSync = async () => {
                await PriceService.syncMarketData(uid, contextData.investments.holdings);
            };

            triggerSync(); // Initial sync
            setInterval(triggerSync, 60000); // Sync every 60s
        }

        // Removed client-side syncPrices function - Logic moved to PriceService "Backend"

        function updateUI() {
            const metrics = InvestmentEngine.calculatePortfolioMetrics(
                contextData.investments.holdings,
                contextData.investments.prices
            );

            const savings = InvestmentEngine.calculateSavingsMetrics(
                contextData.investments.sipPlans,
                contextData.investments.fdAccounts,
                contextData.investments.rdAccounts
            );

            document.getElementById('total-wealth').textContent = `â‚¹${Math.round(metrics.totalValue + savings.totalSaved).toLocaleString('en-IN')}`;

            const totalRet = metrics.totalGain;
            const retSign = totalRet >= 0 ? '+' : '';
            const retEl = document.getElementById('total-returns');
            retEl.textContent = `${retSign}â‚¹${Math.abs(Math.round(totalRet)).toLocaleString('en-IN')} (${metrics.gainPercentage.toFixed(2)}%)`;
            retEl.className = `return-badge ${totalRet >= 0 ? '' : 'negative'}`;

            const dailySign = metrics.dailyGain >= 0 ? '+' : '';
            const dailyEl = document.getElementById('daily-gain');
            const dailyPerc = metrics.totalValue > metrics.dailyGain ? (metrics.dailyGain / (metrics.totalValue - metrics.dailyGain)) * 100 : 0;
            dailyEl.textContent = `${dailySign}â‚¹${Math.abs(Math.round(metrics.dailyGain)).toLocaleString('en-IN')} (${dailyPerc.toFixed(2)}%)`;
            dailyEl.className = `p-value ${metrics.dailyGain >= 0 ? 'up' : 'down'}`;

            renderPortfolioChart(metrics.totalValue + savings.totalSaved);
            updateAIInsight(metrics, savings);
            renderGoldList();
            renderStocksList();
            renderSavingsList();
        }

        function updateTickerUI(prices) {
            const ticker = document.getElementById('price-ticker');
            if (!ticker) return;
            // Show top 5 movers + Gold/Silver
            const items = Object.values(prices).slice(0, 10);

            if (items.length === 0) {
                ticker.innerHTML = '<div style="padding:0 20px; font-style:italic; opacity:0.7;">Initializing real-time market data feed...</div>';
                return;
            }

            ticker.innerHTML = items.map(data => {
                if (!data) return '';
                // Try to guess name from id if symbol is missing, or use ID
                const symbol = data.id || '---';
                const price = data.price || 0;
                const change = data.changePercent || '0%';
                const isDown = change.startsWith('-');
                return `
                  <div class="ticker-item">
                    <span>${symbol}</span> 
                    <span class="ticker-price">â‚¹${Math.round(price).toLocaleString('en-IN')}</span> 
                    <span class="ticker-change ${isDown ? 'down' : 'up'}">${change}</span>
                  </div>
                `;
            }).join('');
        }

        function renderPortfolioChart(currentValue) {
            const chartEl = document.getElementById('portfolio-performance-chart');
            if (!chartEl) return;

            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            portfolioHistory.push({ x: now.getTime(), y: currentValue });
            if (portfolioHistory.length > 50) portfolioHistory.shift();

            // ApexCharts
            if (portfolioChart) {
                portfolioChart.updateSeries([{ data: portfolioHistory }]);
            } else {
                const options = {
                    series: [{ name: 'Portfolio Value', data: portfolioHistory }],
                    chart: {
                        type: 'area',
                        height: 350,
                        animations: { enabled: true, easing: 'linear', dynamicAnimation: { speed: 1000 } },
                        toolbar: { show: false },
                        zoom: { enabled: false },
                        fontFamily: 'Inter, sans-serif'
                    },
                    colors: ['#00D09C'],
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 3 },
                    fill: {
                        type: 'gradient',
                        gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 90, 100] }
                    },
                    grid: { borderColor: '#f1f1f1', strokeDashArray: 4 },
                    xaxis: {
                        type: 'datetime',
                        tooltip: { enabled: false },
                        axisBorder: { show: false },
                        axisTicks: { show: false },
                        labels: { show: false } // minimalist
                    },
                    yaxis: {
                        show: true,
                        labels: { formatter: (value) => 'â‚¹' + Math.round(value).toLocaleString('en-IN') }
                    },
                    theme: { mode: 'light' }
                };

                // Clear previous canvas if any (Chart.js residue)
                chartEl.innerHTML = '';
                // ApexCharts renders into a div, not canvas. We need to replace canvas with div if not done.
                // But chartEl is <canvas> in HTML. We should check if it's canvas and replace it or parent.
                // Actually, let's fix the HTML element in another replacement or here.
                // Wait, chartEl id="portfolio-performance-chart" was a canvas. ApexCharts needs a DIV.
                // I will assume I can handle this by replacing the canvas with a div in the DOM script if needed, 
                // but better to replace the HTML tag itself. 
                // Let's change the logic: IF it is a canvas, replace it with a div.
                if (chartEl.tagName === 'CANVAS') {
                    const div = document.createElement('div');
                    div.id = 'portfolio-performance-chart';
                    chartEl.parentNode.replaceChild(div, chartEl);
                    portfolioChart = new ApexCharts(document.querySelector("#portfolio-performance-chart"), options);
                    portfolioChart.render();
                } else {
                    portfolioChart = new ApexCharts(chartEl, options);
                    portfolioChart.render();
                }
            }
        }

        async function updateAIInsight(metrics, savings) {
            const summary = InvestmentEngine.generateSummaryForAI(metrics, savings);
            const insight = await AIService.generateInvestmentInsight(summary);
            if (insight) document.getElementById('ai-wealth-insight').innerHTML = insight;
        }

        function renderStocksList() {
            const container = document.getElementById('stocks-list');
            if (!container) return;
            // Filter only true stocks
            const holdings = contextData.investments.holdings.filter(h => h.type === 'STOCK');
            if (holdings.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; background: #fff; border-radius: 12px; border: 1px dashed var(--border);">
                        <p style="color: var(--muted); margin-bottom: 16px;">Add stocks to track your portfolio.</p>
                        <button class="btn btn-primary" style="background: var(--groww-green); border:none;" onclick="document.getElementById('add-holding-modal').style.display='flex'">+ Add Stocks</button>
                    </div>
                `;
                return;
            }
            container.innerHTML = holdings.map(h => {
                const priceData = contextData.investments.prices[h.symbol];
                const price = (priceData && typeof priceData === 'object' ? priceData.price : priceData) || h.avgPrice || 0;
                const currentVal = price * h.quantity;
                const investedVal = (h.avgPrice || 0) * h.quantity;
                const returns = currentVal - investedVal;
                const returnPerc = investedVal > 0 ? (returns / investedVal) * 100 : 0;
                return `
                    <div class="instrument-card">
                        <div style="display: flex; justify-content: space-between;">
                            <h4 style="margin:0;">${h.name || h.symbol}</h4>
                            <span style="font-size: 0.7rem; background: var(--groww-bg); padding: 2px 6px; border-radius: 4px;">${h.symbol}</span>
                        </div>
                        <p style="font-size:0.8rem; color:var(--muted); margin-top: 4px;">${h.quantity} Qty â€¢ Avg: â‚¹${(h.avgPrice || 0).toLocaleString()}</p>
                        <div style="margin-top:16px; display:flex; justify-content:space-between; align-items:flex-end;">
                            <div>
                                <span style="font-size:0.75rem; color:var(--muted);">Market Value</span>
                                <div style="font-weight:800; font-size: 1.1rem;">â‚¹${Math.round(currentVal).toLocaleString('en-IN')}</div>
                            </div>
                            <div class="return-badge ${returns >= 0 ? '' : 'negative'}">
                                ${returns >= 0 ? '+' : ''}${returnPerc.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderGoldList() {
            const container = document.getElementById('gold-list');
            if (!container) return;
            const goldPrice = contextData.investments.prices['GOLD'] ? contextData.investments.prices['GOLD'].price : 0;
            const silverPrice = contextData.investments.prices['SILVER'] ? contextData.investments.prices['SILVER'].price : 0;

            const goldHolding = contextData.investments.holdings.find(h => h.symbol === 'GOLD');
            const silverHolding = contextData.investments.holdings.find(h => h.symbol === 'SILVER');

            // Calculate value
            const goldVal = goldHolding ? goldHolding.quantity * goldPrice : 0;
            const silverVal = silverHolding ? silverHolding.quantity * silverPrice : 0;

            container.innerHTML = `
                <div class="instrument-card">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4>Gold (24K)</h4> 
                    ${goldHolding ? `<span class="return-badge">Owning â‚¹${Math.round(goldVal).toLocaleString()}</span>` : ''}
                  </div>
                  <p style="font-size:0.8rem; color:var(--muted);">Digital Gold â€¢ Safe Haven</p>
                  <div style="margin-top:12px;">
                    <span style="font-size:1.5rem; font-weight:800;">â‚¹${Math.round(goldPrice).toLocaleString('en-IN')}</span> <span style="font-size:0.75rem; color:var(--muted);">/10g</span>
                    ${goldHolding ? `<div style="margin-top:8px; font-weight:600; color:var(--groww-green);">Holdings: ${goldHolding.quantity} g</div>` : ''}
                  </div>
                </div>

                <div class="instrument-card">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4>Silver</h4> 
                    ${silverHolding ? `<span class="return-badge">Owning â‚¹${Math.round(silverVal).toLocaleString()}</span>` : ''}
                  </div>
                  <p style="font-size:0.8rem; color:var(--muted);">Industrial â€¢ Precious</p>
                  <div style="margin-top:12px;">
                    <span style="font-size:1.5rem; font-weight:800;">â‚¹${Math.round(silverPrice).toLocaleString('en-IN')}</span> <span style="font-size:0.75rem; color:var(--muted);">/kg</span>
                    ${silverHolding ? `<div style="margin-top:8px; font-weight:600; color:var(--groww-green);">Holdings: ${silverHolding.quantity} g</div>` : ''}
                  </div>
                </div>
            `;
        }

        function renderSavingsList() {
            const container = document.getElementById('savings-list');
            if (!container) return;

            let html = '';

            // SIPs
            contextData.investments.sipPlans.forEach(s => {
                const perc = Math.min(100, (s.currentInvested / s.targetAmount) * 100);
                html += `
                <div class="instrument-card">
                  <div style="display:flex; justify-content:space-between;">
                    <h4>SIP: ${s.name}</h4>
                    <span style="font-size:0.8rem; background:rgba(0,0,0,0.05); padding:2px 8px; border-radius:4px;">Mutual Fund</span>
                  </div>
                  <p style="font-size:0.8rem; color:var(--muted);">Monthly Investment: â‚¹${s.monthlyAmount.toLocaleString('en-IN')}</p>
                  <div style="margin-top:12px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:4px;">
                        <span>â‚¹${s.currentInvested.toLocaleString()} saved</span>
                        <span>Goal: â‚¹${s.targetAmount.toLocaleString()}</span>
                    </div>
                    <div class="savings-bar-container"><div class="savings-bar" style="width: ${perc}%;"></div></div>
                  </div>
                </div>`;
            });

            // FDs
            contextData.investments.fdAccounts.forEach(fd => {
                html += `
                <div class="instrument-card">
                  <div style="display:flex; justify-content:space-between;">
                    <h4>FD: ${fd.name}</h4>
                    <span style="font-size:0.8rem; background:rgba(76, 175, 80, 0.1); color:#4CAF50; padding:2px 8px; border-radius:4px;">${fd.interestRate}% Return</span>
                  </div>
                  <p style="font-size:0.8rem; color:var(--muted);">Principal: â‚¹${fd.principal.toLocaleString('en-IN')}</p>
                  <div style="margin-top:12px;">
                     <div style="font-size:0.9rem; font-weight:700;">Maturity: â‚¹${fd.maturityValue.toLocaleString()}</div>
                     <span style="font-size:0.7rem; color:var(--muted);">Fixed Deposit</span>
                  </div>
                </div>`;
            });

            // RDs
            contextData.investments.rdAccounts.forEach(rd => {
                const perc = Math.min(100, (rd.currentBalance / rd.targetAmount) * 100);
                html += `
                <div class="instrument-card">
                  <div style="display:flex; justify-content:space-between;">
                    <h4>RD: ${rd.name}</h4>
                    <span style="font-size:0.8rem; background:rgba(33, 150, 243, 0.1); color:#2196F3; padding:2px 8px; border-radius:4px;">Recurring</span>
                  </div>
                  <p style="font-size:0.8rem; color:var(--muted);">Current Balance: â‚¹${rd.currentBalance.toLocaleString('en-IN')}</p>
                  <div style="margin-top:12px;">
                     <div class="savings-bar-container"><div class="savings-bar" style="background:#2196F3; width: ${perc}%;"></div></div>
                     <span style="font-size:0.75rem; color:var(--muted);">${perc.toFixed(0)}% completed</span>
                  </div>
                </div>`;
            });

            container.innerHTML = html || '<p style="color:var(--muted); padding:20px; grid-column:1/-1; text-align:center;">No active savings plans found. Add one to start tracking!</p>';
        }
    </script>
</body>

</html>