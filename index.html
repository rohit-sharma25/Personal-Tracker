<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EXPENSIFY - Smart Expense Tracking</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="css/animations.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content animate-fade-in-down">
        <div class="brand">
          <div class="brand-logo">üí∞</div>
          <div class="brand-text">
            <h1>EXPENSIFY</h1>
            <p>Track all of expenses and transactions</p>
          </div>
        </div>

        <div class="user-section" id="auth-section">
          <div id="logged-out-view" class="row">
            <button id="login-btn" class="btn btn-primary">Sign in with Google</button>
            <button id="skip-btn" class="btn btn-secondary">Use Offline</button>
          </div>

          <div id="user-info" class="user-section hidden">
            <div class="user-info">
              <span id="user-name" class="user-name"></span>
              <span id="user-email" class="user-email"></span>
            </div>
            <img id="user-photo" class="user-photo" src="" alt="Profile" />
            <button id="logout-btn" class="btn btn-ghost">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Greeting Section -->
    <section class="greeting-section animate-fade-in-up">
      <div class="greeting-content">
        <div class="greeting-header">
          <div class="greeting-text">
            <h2>Hi, <span id="greeting-name">Ananya</span> üëã</h2>
            <p>Track all of expenses and transactions</p>
          </div>
          <div class="greeting-time" id="current-time">
            <span>üïê</span>
            <span id="time-display"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid animate-fade-in-up stagger-1">
      <!-- Account Balance Card -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-icon">üí≥</div>
          <span class="stat-card-badge" style="background: rgba(91, 108, 242, 0.15); color: #5B6CF2;">BALANCE</span>
        </div>
        <div class="stat-card-body">
          <h3>Account Balance</h3>
          <div class="stat-card-value" id="account-balance">‚Çπ0.00</div>
          <div class="stat-card-trend trend-up" id="balance-trend">
            <span>‚Üë</span>
            <span>+12% from last month</span>
          </div>
        </div>
      </div>

      <!-- Monthly Expenses Card -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-icon">üìä</div>
          <span class="stat-card-badge" style="background: rgba(239, 68, 68, 0.15); color: #EF4444;">EXPENSES</span>
        </div>
        <div class="stat-card-body">
          <h3>Monthly Expenses</h3>
          <div class="stat-card-value"
            style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"
            id="monthly-expenses">‚Çπ0.00</div>
          <div class="stat-card-trend" id="expense-trend">
            <span>üìâ</span>
            <span>5% less than last month</span>
          </div>
        </div>
      </div>

      <!-- Total Investment Card -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-icon">üìà</div>
          <span class="stat-card-badge" style="background: rgba(124, 58, 237, 0.15); color: #7C3AED;">INVESTMENT</span>
        </div>
        <div class="stat-card-body">
          <h3>Total Investment</h3>
          <div class="stat-card-value"
            style="background: linear-gradient(135deg, #7C3AED 0%, #A855F7 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"
            id="total-investment">‚Çπ0.00</div>
          <div class="stat-card-trend trend-up" id="investment-trend">
            <span>‚Üë</span>
            <span>+8% growth</span>
          </div>
        </div>
      </div>

      <!-- Goal Card with Edit Functionality -->
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-icon">üéØ</div>
          <span class="stat-card-badge" style="background: rgba(16, 185, 129, 0.15); color: #10B981;">GOAL</span>
        </div>
        <div class="stat-card-body">
          <!-- Goal Display -->
          <div id="goal-display">
            <h3 id="goal-name-display">No Goal Set</h3>
            <div class="stat-card-value"
              style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"
              id="goal-amount-display">‚Çπ0.00</div>
            <div class="stat-card-trend" id="goal-progress-display">
              <div
                style="width: 100%; background: rgba(0,0,0,0.1); height: 6px; border-radius: 99px; margin-top: 8px; overflow: hidden;">
                <div id="goal-progress-bar"
                  style="width: 0%; height: 100%; background: linear-gradient(90deg, #10B981 0%, #059669 100%); border-radius: 99px;">
                </div>
              </div>
              <span id="goal-progress-text" style="margin-top: 4px; font-size: 0.8rem;">0% Complete</span>
            </div>
            <button id="edit-goal-btn" class="btn btn-secondary"
              style="margin-top: 12px; width: 100%; font-size: 0.85rem;">
              ‚úèÔ∏è Edit Goal
            </button>
          </div>

          <!-- Goal Edit Form (Hidden by default) -->
          <div id="goal-edit-form" class="hidden">
            <div style="margin-bottom: 12px;">
              <label
                style="display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 6px; font-weight: 600;">GOAL
                NAME</label>
              <input type="text" id="goal-name-input" placeholder="e.g., iPhone 17 Pro"
                style="width: 100%; padding: 8px 12px; font-size: 0.9rem;" />
            </div>
            <div style="margin-bottom: 12px;">
              <label
                style="display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 6px; font-weight: 600;">TARGET
                AMOUNT (‚Çπ)</label>
              <input type="number" id="goal-amount-input" placeholder="0.00" step="0.01"
                style="width: 100%; padding: 8px 12px; font-size: 0.9rem;" />
            </div>
            <div style="margin-bottom: 12px;">
              <label
                style="display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 6px; font-weight: 600;">CURRENT
                SAVINGS (‚Çπ)</label>
              <input type="number" id="goal-saved-input" placeholder="0.00" step="0.01"
                style="width: 100%; padding: 8px 12px; font-size: 0.9rem;" />
            </div>
            <div class="row" style="gap: 8px;">
              <button id="save-goal-btn" class="btn btn-primary" style="flex: 1; font-size: 0.85rem;">
                üíæ Save Goal
              </button>
              <button id="cancel-goal-btn" class="btn btn-ghost" style="font-size: 0.85rem;">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section animate-fade-in-up stagger-2">
      <!-- Monthly Expenses Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">üìä Monthly Expenses</h3>
          <div class="chart-filter">
            <button class="filter-btn active" data-period="6m">6 Month</button>
            <button class="filter-btn" data-period="1y">1 Year</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="monthly-chart"></canvas>
        </div>
      </div>

      <!-- Top Category Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">üéØ Top Category</h3>
          <div class="chart-filter">
            <button class="filter-btn active" data-view="recent">Recent</button>
          </div>
        </div>
        <div class="chart-container" style="height: 250px;">
          <canvas id="category-chart"></canvas>
        </div>
        <div class="category-list" id="category-list">
          <!-- Categories will be dynamically inserted -->
        </div>
      </div>
    </div>

    <!-- Recent Expenses Section -->
    <section class="expenses-section animate-fade-in-up stagger-3">
      <div class="section-header">
        <h3 class="section-title">üìã Recent Expenses</h3>
        <div class="row">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="recent">Recent</button>
          <a href="expense.html" class="btn btn-primary">+ Add Expense</a>
        </div>
      </div>

      <table class="expenses-table">
        <thead>
          <tr>
            <th>S.N</th>
            <th>Amount</th>
            <th>Category</th>
            <th>Sub Category</th>
            <th>Date</th>
            <th>Mode</th>
          </tr>
        </thead>
        <tbody id="expenses-table-body">
          <!-- Expenses will be dynamically inserted -->
        </tbody>
      </table>
    </section>

    <!-- Bill & Subscription Section -->
    <section class="expenses-section animate-fade-in-up stagger-4">
      <div class="section-header">
        <h3 class="section-title">üí≥ Bill & Subscription</h3>
        <button class="btn btn-secondary">View All</button>
      </div>

      <div class="dashboard-grid" id="subscriptions-grid">
        <!-- Subscriptions will be dynamically inserted -->
      </div>
    </section>
  </main>

  <!-- AI FAB -->
  <div id="ai-fab" class="ai-fab">
    <span>‚ú®</span>
  </div>

  <!-- AI CHAT POPUP -->
  <div id="ai-chat-popup" class="ai-chat-popup hidden">
    <div class="ai-chat-header">
      <div class="ai-chat-title">
        <span>‚ú®</span>
        <strong>AI Financial Advisor</strong>
      </div>
      <button id="ai-close" class="btn btn-ghost" style="font-size:1.2rem;">&times;</button>
    </div>
    <div id="ai-chat-body" class="ai-chat-body">
      <div class="msg-ai">Hello! I'm your AI financial advisor. Ask me anything about your expenses, budget, or savings!
      </div>
    </div>
    <div class="ai-chat-footer">
      <input type="text" id="ai-chat-input" placeholder="Ask about your expenses..." autocomplete="off">
      <button id="ai-chat-send" class="ai-chat-send">&rarr;</button>
    </div>
  </div>

  <script type="module">
    import { AuthService } from './js/auth-service.js';
    import { DBService } from './js/db-service.js';
    import { AIService } from './js/ai-service.js';

    // DOM Elements
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const skipBtn = document.getElementById('skip-btn');
    const loggedOutView = document.getElementById('logged-out-view');
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const userPhoto = document.getElementById('user-photo');
    const greetingName = document.getElementById('greeting-name');

    // AI Chat elements
    const fab = document.getElementById('ai-fab');
    const popup = document.getElementById('ai-chat-popup');
    const closeBtn = document.getElementById('ai-close');
    const chatInput = document.getElementById('ai-chat-input');
    const chatSend = document.getElementById('ai-chat-send');
    const chatBody = document.getElementById('ai-chat-body');

    let contextData = { finances: [], budget: null };
    let monthlyChart = null;
    let categoryChart = null;
    let currentUser = null;

    // Update time
    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-IN', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
      const dateStr = now.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
      document.getElementById('time-display').textContent = `${timeStr} | ${dateStr}`;
    }
    updateTime();
    setInterval(updateTime, 60000);

    // Auth handling
    AuthService.onUserChange(async (user) => {
      currentUser = user;
      if (user) {
        userInfo.classList.remove('hidden');
        loggedOutView.classList.add('hidden');
        userName.textContent = user.displayName;
        userEmail.textContent = user.email;
        userPhoto.src = user.photoURL;
        greetingName.textContent = user.displayName.split(' ')[0];
        loadData(user.uid);
      } else {
        const isLocal = AuthService.isLocalOnly();
        if (isLocal) {
          userInfo.classList.remove('hidden');
          loggedOutView.classList.add('hidden');
          userName.textContent = "Guest User";
          userEmail.textContent = "Local Mode";
          userPhoto.src = "https://ui-avatars.com/api/?name=Guest&background=5B6CF2&color=fff";
          greetingName.textContent = "Guest";
          loadData(null);
        } else {
          loggedOutView.classList.remove('hidden');
          userInfo.classList.add('hidden');
        }
      }
    });

    async function loadData(uid) {
      // Set up real-time subscriptions for automatic updates
      DBService.subscribe(uid, 'finances', (data) => {
        contextData.finances = data;
        renderDashboard(contextData.finances, contextData.budget);
        renderCharts(contextData.finances);
        renderRecentExpenses(contextData.finances);
        renderSubscriptions(contextData.finances);
      });

      DBService.subscribe(uid, 'monthlyBudget', (data) => {
        const settings = data.find(d => d.id === 'settings');
        contextData.budget = settings ? settings.value : null;
        renderDashboard(contextData.finances, contextData.budget);
      });

      DBService.subscribe(uid, 'goals', (data) => {
        const savedGoal = data.find(g => g.id === 'userGoal');
        if (savedGoal) {
          updateGoalDisplay(savedGoal);
        }
      });
    }

    // Goal Management Functions
    function updateGoalDisplay(goal) {
      if (!goal || !goal.name || !goal.targetAmount) {
        document.getElementById('goal-name-display').textContent = 'No Goal Set';
        document.getElementById('goal-amount-display').textContent = '‚Çπ0.00';
        document.getElementById('goal-progress-bar').style.width = '0%';
        document.getElementById('goal-progress-text').textContent = '0% Complete';
        return;
      }

      const savedAmount = goal.savedAmount || 0;
      const targetAmount = goal.targetAmount || 0;
      const progress = targetAmount > 0 ? Math.min((savedAmount / targetAmount) * 100, 100) : 0;

      document.getElementById('goal-name-display').textContent = goal.name;
      document.getElementById('goal-amount-display').textContent = `‚Çπ${targetAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('goal-progress-bar').style.width = `${progress}%`;
      document.getElementById('goal-progress-text').textContent = `${progress.toFixed(0)}% Complete (‚Çπ${savedAmount.toLocaleString('en-IN')} saved)`;
    }

    // Goal Edit/Save Handlers
    document.getElementById('edit-goal-btn').addEventListener('click', async () => {
      const goalData = await DBService.fetchData(AuthService.isLocalOnly() ? null : currentUser?.uid, 'goals');
      const savedGoal = goalData.find(g => g.id === 'userGoal');

      if (savedGoal) {
        document.getElementById('goal-name-input').value = savedGoal.name || '';
        document.getElementById('goal-amount-input').value = savedGoal.targetAmount || '';
        document.getElementById('goal-saved-input').value = savedGoal.savedAmount || '';
      }

      document.getElementById('goal-display').classList.add('hidden');
      document.getElementById('goal-edit-form').classList.remove('hidden');
    });

    document.getElementById('cancel-goal-btn').addEventListener('click', () => {
      document.getElementById('goal-edit-form').classList.add('hidden');
      document.getElementById('goal-display').classList.remove('hidden');
    });

    document.getElementById('save-goal-btn').addEventListener('click', async () => {
      const name = document.getElementById('goal-name-input').value.trim();
      const targetAmount = parseFloat(document.getElementById('goal-amount-input').value) || 0;
      const savedAmount = parseFloat(document.getElementById('goal-saved-input').value) || 0;

      if (!name || targetAmount <= 0) {
        alert('Please enter a valid goal name and target amount');
        return;
      }

      const goalData = {
        id: 'userGoal',
        name,
        targetAmount,
        savedAmount
      };

      const uid = AuthService.isLocalOnly() ? null : currentUser?.uid;
      await DBService.saveData(uid, 'goals', 'userGoal', goalData);

      updateGoalDisplay(goalData);
      document.getElementById('goal-edit-form').classList.add('hidden');
      document.getElementById('goal-display').classList.remove('hidden');
    });

    function renderDashboard(finances, budget) {
      const today = new Date();
      const currentMonth = today.toISOString().slice(0, 7);

      // Calculate monthly expenses
      const monthExpenses = finances
        .filter(f => f.type === 'expense' && f.dateISO.startsWith(currentMonth))
        .reduce((sum, f) => sum + f.amount, 0);

      // Calculate monthly income
      const monthIncome = finances
        .filter(f => f.type === 'income' && f.dateISO.startsWith(currentMonth))
        .reduce((sum, f) => sum + f.amount, 0);

      // Calculate total investment
      const totalInvestment = finances
        .filter(f => f.category === 'Investment')
        .reduce((sum, f) => sum + f.amount, 0);

      // Update dashboard
      document.getElementById('account-balance').textContent = `‚Çπ${(monthIncome - monthExpenses).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('monthly-expenses').textContent = `‚Çπ${monthExpenses.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('total-investment').textContent = `‚Çπ${totalInvestment.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function renderCharts(finances) {
      renderMonthlyChart(finances);
      renderCategoryChart(finances);
    }

    function renderMonthlyChart(finances) {
      const ctx = document.getElementById('monthly-chart');
      if (!ctx) return;

      // Get last 6 months data
      const months = [];
      const data = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const monthStr = d.toISOString().slice(0, 7);
        const monthName = d.toLocaleDateString('en-IN', { month: 'short' });
        months.push(monthName);

        const monthTotal = finances
          .filter(f => f.type === 'expense' && f.dateISO.startsWith(monthStr))
          .reduce((sum, f) => sum + f.amount, 0);
        data.push(monthTotal);
      }

      if (monthlyChart) monthlyChart.destroy();

      monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Expenses',
            data: data,
            backgroundColor: 'rgba(91, 108, 242, 0.8)',
            borderColor: '#5B6CF2',
            borderWidth: 2,
            borderRadius: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(17, 18, 26, 0.95)',
              padding: 12,
              titleColor: '#F9FAFB',
              bodyColor: '#E5E7EB',
              borderColor: 'rgba(91, 108, 242, 0.3)',
              borderWidth: 1,
              callbacks: {
                label: (context) => `‚Çπ${context.parsed.y.toLocaleString('en-IN')}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: { color: '#9CA3AF' }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#9CA3AF' }
            }
          }
        }
      });
    }

    function renderCategoryChart(finances) {
      const ctx = document.getElementById('category-chart');
      if (!ctx) return;

      // Calculate category totals
      const categories = {};
      const categoryColors = {
        'Food & Grocery': '#10B981',
        'Investment': '#8B5CF6',
        'Shopping': '#F59E0B',
        'Traveling': '#06B6D4',
        'Miscellaneous': '#6B7280',
        'Bill & Subscription': '#EF4444'
      };

      finances
        .filter(f => f.type === 'expense')
        .forEach(f => {
          const cat = f.category || 'Miscellaneous';
          categories[cat] = (categories[cat] || 0) + f.amount;
        });

      const labels = Object.keys(categories);
      const data = Object.values(categories);
      const colors = labels.map(l => categoryColors[l] || '#6B7280');

      if (categoryChart) categoryChart.destroy();

      categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(17, 18, 26, 0.95)',
              padding: 12,
              titleColor: '#F9FAFB',
              bodyColor: '#E5E7EB',
              borderColor: 'rgba(91, 108, 242, 0.3)',
              borderWidth: 1,
              callbacks: {
                label: (context) => `${context.label}: ‚Çπ${context.parsed.toLocaleString('en-IN')}`
              }
            }
          },
          cutout: '70%'
        }
      });

      // Render category list
      const categoryList = document.getElementById('category-list');
      categoryList.innerHTML = labels.map((label, i) => `
        <div class="category-item">
          <div class="category-color" style="background: ${colors[i]}"></div>
          <div class="category-info">
            <span class="category-name">${label}</span>
            <span class="category-amount">‚Çπ${data[i].toLocaleString('en-IN')}</span>
          </div>
        </div>
      `).join('');
    }

    function renderRecentExpenses(finances) {
      const tbody = document.getElementById('expenses-table-body');
      const recent = finances
        .filter(f => f.type === 'expense')
        .sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO))
        .slice(0, 5);

      const categoryColors = {
        'Food & Grocery': '#10B981',
        'Investment': '#8B5CF6',
        'Shopping': '#F59E0B',
        'Traveling': '#06B6D4',
        'Miscellaneous': '#6B7280',
        'Bill & Subscription': '#EF4444'
      };

      tbody.innerHTML = recent.map((exp, i) => {
        const color = categoryColors[exp.category] || '#6B7280';
        return `
          <tr>
            <td>${i + 1}</td>
            <td class="expense-amount">‚Çπ${exp.amount.toLocaleString('en-IN')}</td>
            <td>
              <span class="expense-category-badge" style="background: ${color}20; color: ${color}">
                ${exp.category || 'Other'}
              </span>
            </td>
            <td class="expense-mode">${exp.subCategory || '-'}</td>
            <td class="expense-date">${new Date(exp.dateISO).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
            <td class="expense-mode">${exp.mode || 'UPI'}</td>
          </tr>
        `;
      }).join('');
    }

    function renderSubscriptions(finances) {
      const grid = document.getElementById('subscriptions-grid');
      const subscriptions = finances
        .filter(f => f.category === 'Bill & Subscription')
        .slice(0, 4);

      const icons = {
        'Netflix': 'üé¨',
        'Spotify': 'üéµ',
        'WiFi': 'üì°',
        'Electricity': '‚ö°'
      };

      grid.innerHTML = subscriptions.map(sub => `
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-icon">${icons[sub.subCategory] || 'üí≥'}</div>
            <span class="stat-card-badge" style="background: rgba(239, 68, 68, 0.15); color: #EF4444;">ACTIVE</span>
          </div>
          <div class="stat-card-body">
            <h3>${sub.subCategory || sub.description}</h3>
            <div class="stat-card-value" style="font-size: 1.5rem;">‚Çπ${sub.amount.toLocaleString('en-IN')}</div>
            <div class="stat-card-trend">
              <span style="font-size: 0.8rem; color: var(--muted);">${new Date(sub.dateISO).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' })}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // AI Chat
    fab.onclick = () => popup.classList.toggle('hidden');
    closeBtn.onclick = () => popup.classList.add('hidden');

    async function handleChat() {
      const msg = chatInput.value.trim();
      if (!msg) return;

      const userMsg = document.createElement('div');
      userMsg.className = 'msg-user';
      userMsg.textContent = msg;
      chatBody.appendChild(userMsg);
      chatInput.value = "";
      chatBody.scrollTop = chatBody.scrollHeight;

      const aiMsg = document.createElement('div');
      aiMsg.className = 'msg-ai';
      aiMsg.textContent = "...";
      chatBody.appendChild(aiMsg);

      const response = await AIService.chat(msg, contextData);
      aiMsg.innerHTML = response;
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    chatSend.onclick = handleChat;
    chatInput.onkeydown = (e) => e.key === 'Enter' && handleChat();

    loginBtn.addEventListener('click', () => AuthService.login());
    skipBtn.addEventListener('click', () => { AuthService.setLocalOnly(true); location.reload(); });
    logoutBtn.addEventListener('click', () => { AuthService.setLocalOnly(false); AuthService.logout(); location.reload(); });
  </script>
</body>

</html>