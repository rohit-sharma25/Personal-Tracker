<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NeonSync Hub - Intelligent Life Tracking</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="css/animations.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <header class="container header-row animate-fade-in-down">
    <div>
      <h1 class="animate-gradient"
        style="background: linear-gradient(to right, #6c5ce7, #a29bfe, #6c5ce7); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% auto;">
        NeonSync</h1>
      <p class="muted">Intelligent Life Tracking.</p>
    </div>

    <div class="topbar">
      <div id="auth-section" class="user-area">
        <div id="logged-out-view" class="row">
          <button id="login-btn" class="btn accent hover-lift">Sign in with Google</button>
          <button id="skip-btn" class="btn secondary hover-scale">Use Local-only</button>
        </div>

        <div id="user-info" class="user-info hidden">
          <div class="row">
            <img id="user-photo" class="user-photo" src="" alt="Profile" />
            <span id="user-name" class="muted"></span>
            <button id="logout-btn" class="btn ghost" style="color:var(--danger); font-size:0.8rem;">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Quick Stats Dashboard -->
    <section id="stats-dashboard" class="stats-grid animate-fade-in-up" style="margin-bottom: 30px;">
      <!-- Stats will be dynamically inserted here -->
    </section>

    <!-- Feature Cards -->
    <div class="home-grid">
      <a href="habit.html" class="card hover-lift animate-fade-in-up stagger-1"
        style="text-decoration:none; color:inherit;">
        <div class="row" style="justify-content:space-between; margin-bottom: 10px;">
          <h3 style="margin: 0; font-size: 1.3rem;">Habits</h3>
          <span style="font-size: 2rem;" class="animate-float">ðŸ”¥</span>
        </div>
        <p class="muted" style="margin: 10px 0;">Build routines and track daily streaks.</p>
        <div class="row" style="justify-content: space-between; align-items: center; margin-top: 15px;">
          <div class="badge badge-primary">Cloud Enabled</div>
          <span id="habit-quick-stat" class="muted" style="font-size: 0.85rem;">Loading...</span>
        </div>
      </a>

      <a href="expense.html" class="card hover-lift animate-fade-in-up stagger-2"
        style="text-decoration:none; color:inherit;">
        <div class="row" style="justify-content:space-between; margin-bottom: 10px;">
          <h3 style="margin: 0; font-size: 1.3rem;">Finances</h3>
          <span style="font-size: 2rem;" class="animate-float">ðŸ’°</span>
        </div>
        <p class="muted" style="margin: 10px 0;">Manage spending, income and monthly budget.</p>
        <div class="row" style="justify-content: space-between; align-items: center; margin-top: 15px;">
          <div class="badge badge-info">Cloud Enabled</div>
          <span id="finance-quick-stat" class="muted" style="font-size: 0.85rem;">Loading...</span>
        </div>
      </a>
    </div>
  </main>

  <!-- AI FAB -->
  <div id="ai-fab" class="ai-fab">
    <span>âœ¨</span>
  </div>

  <!-- AI CHAT POPUP -->
  <div id="ai-chat-popup" class="ai-chat-popup hidden">
    <div class="ai-chat-header">
      <div class="row">
        <span>âœ¨</span>
        <strong style="font-size:0.9rem;">Neon Assistant</strong>
      </div>
      <button id="ai-close" class="btn ghost" style="font-size:1.2rem; color:var(--muted);">&times;</button>
    </div>
    <div id="ai-chat-body" class="ai-chat-body">
      <div class="msg-ai">Hello! I'm your Neon assistant. Ask me anything about your progress!</div>
    </div>
    <div class="ai-chat-footer">
      <input type="text" id="ai-chat-input" placeholder="Type a message..." autocomplete="off">
      <button id="ai-chat-send" class="btn accent"
        style="border-radius:50%; width:36px; height:36px; padding:0;">&rarr;</button>
    </div>
  </div>

  <script type="module">
    import { AuthService } from './js/auth-service.js';
    import { DBService } from './js/db-service.js';
    import { AIService } from './js/ai-service.js';

    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const skipBtn = document.getElementById('skip-btn');
    const loggedOutView = document.getElementById('logged-out-view');
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const userPhoto = document.getElementById('user-photo');

    // AI Chat elements
    const fab = document.getElementById('ai-fab');
    const popup = document.getElementById('ai-chat-popup');
    const closeBtn = document.getElementById('ai-close');
    const chatInput = document.getElementById('ai-chat-input');
    const chatSend = document.getElementById('ai-chat-send');
    const chatBody = document.getElementById('ai-chat-body');

    let contextData = { habits: [], finances: [], budget: null };

    AuthService.onUserChange(async (user) => {
      if (user) {
        userInfo.classList.remove('hidden');
        loggedOutView.classList.add('hidden');
        userName.textContent = user.displayName;
        userPhoto.src = user.photoURL;
        loadData(user.uid);
      } else {
        const isLocal = AuthService.isLocalOnly();
        if (isLocal) {
          userInfo.classList.remove('hidden');
          loggedOutView.classList.add('hidden');
          userName.textContent = "Guest Mode";
          userPhoto.src = "https://ui-avatars.com/api/?name=Guest";
          loadData(null);
        } else {
          loggedOutView.classList.remove('hidden');
          userInfo.classList.add('hidden');
        }
      }
    });

    async function loadData(uid) {
      contextData.habits = await DBService.fetchData(uid, 'activities');
      contextData.finances = await DBService.fetchData(uid, 'finances');
      const b = await DBService.fetchData(uid, 'monthlyBudget');
      contextData.budget = b.find(d => d.id === 'settings')?.value;

      const habitLogs = await DBService.fetchData(uid, 'habitLogs');
      const logs = habitLogs.reduce((acc, doc) => {
        acc[doc.id] = doc.habits;
        return acc;
      }, {});

      renderStatsDashboard(contextData.habits, contextData.finances, contextData.budget, logs);
      updateQuickStats(contextData.habits, contextData.finances);
    }

    function renderStatsDashboard(habits, finances, budget, habitLogs) {
      const dashboard = document.getElementById('stats-dashboard');

      // Calculate stats
      const totalHabits = habits.length;
      const longestStreak = habits.reduce((max, h) => Math.max(max, h.streak || 0), 0);

      const today = new Date();
      const currentMonth = today.toISOString().slice(0, 7);
      const monthExpenses = finances.filter(f => f.type === 'expense' && f.dateISO.startsWith(currentMonth))
        .reduce((sum, f) => sum + f.amount, 0);

      const budgetPercent = budget ? Math.round((monthExpenses / budget) * 100) : 0;

      // Calculate weekly completion
      const weekDates = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        weekDates.push(d.toISOString().slice(0, 10));
      }
      let totalCompleted = 0;
      weekDates.forEach(date => {
        const dayLogs = habitLogs[date] || [];
        totalCompleted += dayLogs.length;
      });
      const weeklyCompletion = totalHabits > 0 ? Math.round((totalCompleted / (totalHabits * 7)) * 100) : 0;

      dashboard.innerHTML = `
        <div class="stat-card hover-lift">
          <span class="stat-card-icon">ðŸŽ¯</span>
          <div class="stat-card-value" id="stat-habits">${totalHabits}</div>
          <div class="stat-card-label">Active Habits</div>
        </div>
        
        <div class="stat-card hover-lift">
          <span class="stat-card-icon">ðŸ”¥</span>
          <div class="stat-card-value" id="stat-streak">${longestStreak}</div>
          <div class="stat-card-label">Longest Streak</div>
        </div>
        
        <div class="stat-card hover-lift">
          <span class="stat-card-icon">ðŸ“Š</span>
          <div class="stat-card-value" id="stat-completion">${weeklyCompletion}%</div>
          <div class="stat-card-label">Weekly Completion</div>
        </div>
        
        <div class="stat-card hover-lift">
          <span class="stat-card-icon">ðŸ’°</span>
          <div class="stat-card-value" style="color: ${budgetPercent > 90 ? 'var(--danger)' : budgetPercent > 70 ? 'var(--warning)' : 'var(--success)'}">â‚¹${monthExpenses.toFixed(0)}</div>
          <div class="stat-card-label">Monthly Spending</div>
          ${budget ? `<div class="stat-card-trend ${budgetPercent > 90 ? 'down' : 'up'}">${budgetPercent}% of budget</div>` : ''}
        </div>
      `;
    }

    function updateQuickStats(habits, finances) {
      const habitStat = document.getElementById('habit-quick-stat');
      const financeStat = document.getElementById('finance-quick-stat');

      const activeHabits = habits.filter(h => (h.streak || 0) > 0).length;
      habitStat.textContent = `${activeHabits} active`;

      const today = new Date().toISOString().slice(0, 10);
      const todaySpent = finances.filter(f => f.type === 'expense' && f.dateISO === today)
        .reduce((sum, f) => sum + f.amount, 0);
      financeStat.textContent = `â‚¹${todaySpent.toFixed(0)} today`;
    }

    fab.onclick = () => popup.classList.toggle('hidden');
    closeBtn.onclick = () => popup.classList.add('hidden');

    async function handleChat() {
      const msg = chatInput.value.trim();
      if (!msg) return;

      const userMsg = document.createElement('div');
      userMsg.className = 'msg-user';
      userMsg.textContent = msg;
      chatBody.appendChild(userMsg);
      chatInput.value = "";
      chatBody.scrollTop = chatBody.scrollHeight;

      const aiMsg = document.createElement('div');
      aiMsg.className = 'msg-ai';
      aiMsg.textContent = "...";
      chatBody.appendChild(aiMsg);

      const response = await AIService.chat(msg, contextData);
      aiMsg.innerHTML = response;
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    chatSend.onclick = handleChat;
    chatInput.onkeydown = (e) => e.key === 'Enter' && handleChat();

    loginBtn.addEventListener('click', () => AuthService.login());
    skipBtn.addEventListener('click', () => { AuthService.setLocalOnly(true); location.reload(); });
    logoutBtn.addEventListener('click', () => { AuthService.setLocalOnly(false); AuthService.logout(); location.reload(); });
  </script>
</body>

</html>